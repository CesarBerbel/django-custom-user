{% extends "base.html" %}
{% load money_extras %}

{% block title %}
  {% if account %}
    Statement for {{ account.bank }}
  {% elif transaction_type %}
    {{ transaction_type }}s
  {% endif %}
{% endblock %}

{% block header %}
  <div class="d-flex align-items-center justify-content-between w-100">
    <div>
      {% if account %}
        Statement for <span class="text-primary">{{ account.bank }}</span>
      {% elif transaction_type %}
        Your {{ transaction_type }}s
      {% endif %}
    </div>
    <!-- NAVEGAÇÃO DE MÊS NO CABEÇALHO -->
    <div class="d-flex align-items-center">
      {% if account %}
        <a href="{% url 'transactions:list_by_account_specific' account_id previous_month.year previous_month.month %}" class="btn btn-sm btn-outline-secondary" style="margin-left: 30px;">
      {% else %}
        <a href="{% url 'transactions:'|add:base_url_name|add:'_specific' previous_month.year previous_month.month %}" class="btn btn-sm btn-outline-secondary" style="margin-left: 30px;">
      {% endif %}
        <i class="bi bi-chevron-left"></i>
      </a>
      <h5 class="mb-0 mx-3">{{ current_month|date:"F Y" }}</h5>
      {% if account %}
        <a href="{% url 'transactions:list_by_account_specific' account_id next_month.year next_month.month %}" class="btn btn-sm btn-outline-secondary">
      {% else %}
        <a href="{% url 'transactions:'|add:base_url_name|add:'_specific' next_month.year next_month.month %}" class="btn btn-sm btn-outline-secondary">
      {% endif %}
        <i class="bi bi-chevron-right"></i>
      </a>
    </div>
  </div>
{% endblock %}

{% block content %}

<!-- RENDERIZAÇÃO CONDICIONAL DOS RESUMOS -->

{% if account %}
    <!-- MODO EXTRATO DE CONTA (com Variáveis Corretas) -->
    <div class="row g-3 mb-4">
      <div class="col-md-12">
        <div class="card h-100">
          <div class="card-header bg-light">
              <h6 class="card-title text-muted mb-0"><i class="bi bi-receipt me-2"></i>Account Statement: Flow</h6>
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>
                    Starting Balance
                    <small class="text-muted">({{ starting_balance_type }})</small>
                </span>
                <span>{% money summary.starting_balance account.country %}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center text-success border-top pt-2">
                <span>+ Incomes this month (Completed):</span>
                <!-- NOME DA VARIÁVEL CORRIGIDO -->
                <span>{% money summary.income_this_month_completed account.country %}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center text-danger pb-2">
                <span>- Expenses/Transfers out this month (Completed):</span>
                <!-- NOME DA VARIÁVEL CORRIGIDO -->
                <span>{% money summary.expense_this_month_completed account.country %}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center border-top pt-2">
                <strong>Current Actual Balance (end of month):</strong>
                <strong class="fs-5 {% if summary.current_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                  {% money summary.current_balance account.country %}
                </strong>
            </div>
            <div class="d-flex justify-content-between align-items-center text-muted small mt-2">
              <span>End of month forecasted balance:</span>
              <span class="fw-bold">{% money summary.forecasted_balance account.country %}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
{% elif transaction_type == 'TRANSFER' %}
    <!-- NOVO MODO DE RESUMO PARA TRANSFERÊNCIAS -->
    <div class="row g-3 mb-4">
        <!-- Coluna de Saídas -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted"><i class="bi bi-box-arrow-up-right text-danger"></i> Outflows This Month</h6>
                    <ul class="list-group list-group-flush">
                        {% for outflow in summary.outflows %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ outflow.origin_account__country__currency_code }}</span>
                                <strong class="text-danger">
                                    - {{ outflow.origin_account__country__currency_symbol }} {{ outflow.total_out|stringformat:".2f" }}
                                </strong>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No outflows this month.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <!-- Coluna de Entradas -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-title text-muted"><i class="bi bi-box-arrow-in-down-left text-success"></i> Inflows This Month</h6>
                    <ul class="list-group list-group-flush">
                        {% for inflow in summary.inflows %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ inflow.destination_account__country__currency_code }}</span>
                                <strong class="text-success">
                                    + {{ inflow.destination_account__country__currency_symbol }} {{ inflow.total_in|stringformat:".2f" }}
                                </strong>
                            </li>
                        {% empty %}
                            <li class="list-group-item text-muted">No inflows this month.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% else %}

  <!-- MODO LISTA POR TIPO (Permanece como estava) -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="card-title text-muted"><i class="bi bi-check-circle-fill text-success"></i> Completed This Month</h6>
          <p class="fs-4 fw-bold {% if transaction_type == 'EXPENSE' %}text-danger{% else %}text-success{% endif %}">
            {% money summary.completed preferred_currency %}
          </p>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="card-title text-muted"><i class="bi bi-clock-fill text-primary"></i> Forecasted This Month</h6>
          <p class="fs-4 fw-bold {% if transaction_type == 'EXPENSE' %}text-danger{% else %}text-success{% endif %}">
            {% money summary.forecasted preferred_currency %}
          </p>
        </div>
      </div>
    </div>
  </div>
{% endif %}

<!-- TABELA DE TRANSAÇÕES DO MÊS -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Account</th> <!-- Colunas "From" e "To" unificadas -->
                        <th class="text-end">Value</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- *** ESTRUTURA DO LOOP FOR DEFINITIVAMENTE CORRIGIDA *** -->
                    {% for tx in transactions %}
                    <tr>
                        <td>
                            {% if tx.completion_date %}
                                {{ tx.completion_date|date:"Y-m-d" }}
                            {% else %}
                                {{ tx.date|date:"Y-m-d" }}
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if tx.type == 'INCOME' %}bg-success-subtle text-success-emphasis{% elif tx.type == 'EXPENSE' %}bg-danger-subtle text-danger-emphasis{% else %}bg-info-subtle text-info-emphasis{% endif %}">
                                {{ tx.get_type_display }}
                            </span>
                        </td>
                        <td>
                          {{ tx.description }}
                          {% if tx.installment_number %}
                              <!-- <small class="text-muted d-block">{{ tx.description }}</small> -->
                          {% endif %}
                        </td>
                        <td>{{ tx.category.name|default:"-" }}</td>
                        <td>
                            {% if tx.type == 'EXPENSE' and tx.origin_account %}
                                <a href="{% url 'transactions:list_by_account' tx.origin_account.pk %}">{{ tx.origin_account }}</a>
                            {% elif tx.type == 'INCOME' and tx.destination_account %}
                                <a href="{% url 'transactions:list_by_account' tx.destination_account.pk %}">{{ tx.destination_account }}</a>
                            {% elif tx.type == 'TRANSFER' %}
                                <div>
                                    <small class="text-muted d-block">From:</small>
                                    <a href="{% url 'transactions:list_by_account' tx.origin_account.pk %}">{{ tx.origin_account }}</a>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted d-block">To:</small>
                                    <a href="{% url 'transactions:list_by_account' tx.destination_account.pk %}">{{ tx.destination_account }}</a>
                                </div>
                            {% endif %}
                        </td>
                        <td class="text-end fw-bold">
                            {% if tx.converted_value %}
                                <!-- Caso de transferência com conversão -->
                                <div {% if tx.status == 'OVERDUE' %}class="text-danger"{% endif %}>
                                    - {% money tx.value tx.origin_account.country %}
                                </div>
                                <div class="small text-muted">
                                    -> + {% money tx.converted_value tx.destination_account.country %}
                                </div>
                            {% else %}
                                <!-- Caso normal (despesa, receita ou transferência sem conversão) -->
                                <div class="{% if tx.type == 'EXPENSE' or tx.status == 'OVERDUE' %}text-danger{% elif tx.type == 'INCOME' %}text-success{% endif %}">
                                    {% if tx.type == 'EXPENSE' %}- {% elif tx.type == 'INCOME' %}+ {% endif %}
                                    {% if tx.origin_account %}{% money tx.value tx.origin_account.country %}
                                    {% elif tx.destination_account %}{% money tx.value tx.destination_account.country %}{% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                             <span class="badge {% if tx.status == 'PENDING' %}bg-warning-subtle text-warning-emphasis{% elif tx.status == 'COMPLETED' %}bg-success-subtle text-success-emphasis{% else %}bg-danger-subtle text-danger-emphasis{% endif %}">
                                 {{ tx.get_status_display }}
                             </span>
                        </td>
                        <td class="text-center">
                          {% if tx.status == 'PENDING' or tx.status == 'OVERDUE' %}
                              <!-- BOTÃO DE EFETIVAÇÃO MODIFICADO -->
                              {% if tx.type == 'TRANSFER' and tx.origin_account.country != tx.destination_account.country %}
                                  <!-- Botão que abre o modal para transferências multi-moeda -->
                                  <button type="button" class="btn btn-sm btn-outline-success"
                                          data-bs-toggle="modal"
                                          data-bs-target="#completeTransferModal"
                                          hx-get="{% url 'transactions:prepare_complete_transfer' tx.pk %}"
                                          hx-target="#modal-content-placeholder"
                                          hx-swap="innerHTML"
                                          title="Complete Transfer with Conversion">
                                      <i class="bi bi-check-circle"></i>
                                  </button>
                              {% else %}
                                  <!-- Formulário de POST direto para transações normais -->
                                  <form method="post" action="{% url 'transactions:complete' tx.pk %}" class="d-inline">
                                      {% csrf_token %}
                                      <button type="submit" class="btn btn-sm btn-outline-success" title="Mark as Completed">
                                          <i class="bi bi-check-circle"></i>
                                      </button>
                                  </form>
                              {% endif %}
                          {% else %}
                              -
                          {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="9" class="text-center py-4 text-muted">No transactions found for this period.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
  <div class="modal fade" id="completeTransferModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" id="modal-content-placeholder">
              <!-- O conteúdo será carregado aqui. O spinner pode ser o conteúdo inicial -->
              <div class="modal-body text-center p-4">
                  <div class="spinner-border" role="status">
                      <span class="visually-hidden">Loading...</span>
                  </div>
              </div>
          </div>
      </div>
  </div>
{% endblock %}
