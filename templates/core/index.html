<!-- 
Arquivo: templates/core/index.html
(versão com o script do gráfico RESTAURADO)
-->
{% extends "base.html" %}
{% load money_extras %}
{% load core_extras %}

{% block title %}Dashboard{% endblock %}

{% block header %}
  <!-- CABEÇALHO COM NAVEGAÇÃO DE MÊS -->
  <div class="d-flex align-items-center justify-content-between w-100">
    <span>
        {% if is_current_or_past_month %}{{ title }}{% else %}<a href="/">Go to Home</a>{% endif %}
        <span class="badge bg-light text-dark ms-2">
            {% if is_current_or_past_month %}Actual{% else %}Forecasted{% endif %}
        </span>
    </span>
    <div class="d-flex align-items-center">
        <a href="{% url 'core:home_specific' previous_month.year previous_month.month %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-chevron-left"></i>
        </a>
        <h5 class="mb-0 mx-3">{{ report_date|date:"F Y" }}</h5>
        <a href="{% url 'core:home_specific' next_month.year next_month.month %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-chevron-right"></i>
        </a>
    </div>
  </div>
{% endblock %}

{% block content %}
  {% if not accounts %}
    <div class="text-center p-5 border rounded bg-light">
      <h3 class="h4">Welcome to your dashboard!</h3>
      <p class="text-muted">You don't have any active accounts yet.</p>
      <a href="{% url 'accounts:create' %}" class="btn btn-primary mt-2">
        <i class="bi bi-plus-circle"></i> Create your first account
      </a>
    </div>
  {% else %}
    <!-- Summary Cards -->
    <div class="row g-3">
      {% if total_net_worth %}
      <div class="col-12">
          <div class="card {% if is_current_or_past_month %}bg-primary{% else %}bg-info{% endif %} text-white">
              <div class="card-body text-center">
                  <h5 class="card-title text-white-50">
                    Total {% if is_current_or_past_month %}Actual{% else %}Forecasted{% endif %} Net Worth
                  </h5>
                  <p class="card-text display-5 fw-bold">
                      {% money total_net_worth country=preferred_currency %}
                  </p>
              </div>
          </div>
      </div>
      {% endif %}
    

      {% for item in currency_totals %}
        <div class="col-md-6 col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-muted">Total Balance ({{ item.country__currency_code }})</h5>
              <p class="card-text fs-4 fw-bold">
                {% money item.total symbol=item.country__currency_symbol %}
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
   
    <!-- Accounts Table -->
    <div class="mt-4">
      <h3 class="h4 mb-3">
        Account Balances
        <small class="text-muted fs-6">({% if is_current_or_past_month %}Actual{% else %}Forecasted{% endif %} as of {{ report_date|date:"Y-m-d" }})</small>
      </h3>
      {% include "accounts/_account_table.html" with accounts=accounts %}
    </div>

    <!-- Chart wrapped in a smaller, centered column -->
    <div class="row justify-content-center mt-4">
      <div class="col-lg-10 col-xl-8">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Account Proportions</h5>
            <!-- Reduced the container height for a smaller chart -->
            <div style="position: relative; height:250px">
                <canvas id="accountBalanceChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Appointments Section -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Upcoming from Google</h5>
            {% if google_connected %}
                <a href="{% url 'appointments:disconnect' %}" class="btn btn-outline-danger btn-sm">Disconnect</a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if not google_connected %}
                <p>Connect your Google Account to see your upcoming events and tasks right here.</p>
                <a href="{% url 'appointments:connect' %}" class="btn btn-primary">
                    <i class="bi bi-google"></i> Connect to Google
                </a>
            {% else %}
                <div class="row">
                    <!-- Calendar Events Column -->
                    <div class="col-lg-6">
                        <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-calendar-event me-2"></i>Calendar Events</h6>
                        <ul class="list-group list-group-flush">
                            {% for event in upcoming_calendar_events %}
                                <li class="list-group-item">
                                    <strong class="d-block">{{ event.title }}</strong>
                                    <small class="text-muted">
                                        {{ event.start_time|slice:":16"|replace_str:"T, " }}
                                    </small>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted small">
                                    No upcoming events found.
                                </li>
                            {% endfor %}
                        </ul>
                    </div>

                    <!-- Tasks Column -->
                    <div class="col-lg-6 mt-4 mt-lg-0">
                        <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-check2-square me-2"></i>Tasks</h6>
                        <ul class="list-group list-group-flush">
                            {% for task in upcoming_google_tasks %}
                                <li class="list-group-item">
                                    <strong class="d-block">{{ task.title }}</strong>
                                    <small class="text-muted">
                                        Due: {{ task.due_date|slice:":10" }}
                                    </small>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted small">
                                    No upcoming tasks with a due date found.
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
  {% endif %}
<!-- ############  BLOCO DE WIDGETS DE TRANSAÇÕES - VERSÃO CORRIGIDA E FINAL  ############ -->
    <div class="row mt-4">
      <!-- Coluna da esquerda: Próximas Transações -->
      <div class="col-lg-6">
          <div class="card h-100">
              <div class="card-body">
                  <h6 class="border-bottom pb-2 mb-3">
                      <i class="bi bi-hourglass-split me-2"></i>Upcoming Pending Transactions
                  </h6>
                  <ul class="list-group list-group-flush">
                      {% for tx in upcoming_transactions %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                              <div>                                  
                                  <strong class="d-block">
                                    <i class="{{ tx.category.icon|default:'bi-tag' }} fs-5" style="color: {{ tx.category.color|default:'#6c757d' }};"></i>
                                    {{ tx.description }} - {{ tx.type }}</strong>
                                  <!-- LÓGICA DE STATUS REMOVIDA DAQUI, APENAS EXIBE A DATA -->
                                  <small class="text-muted">
                                      Due on {{ tx.date|date:"M. d, Y" }}
                                  </small>
                              </div>
                              <span class="fw-bold">
                                  {% if tx.origin_account %}
                                      {% money tx.value tx.origin_account.country %}
                                  {% elif tx.destination_account %}
                                      {% money tx.value tx.destination_account.country %}
                                  {% else %}
                                      {{ tx.value|stringformat:".2f" }}
                                  {% endif %}
                              </span>
                          </li>
                      {% empty %}
                          <li class="list-group-item text-muted small">No upcoming pending transactions.</li>
                      {% endfor %}
                  </ul>
              </div>
          </div>
      </div>
      <!-- Coluna da direita: Últimas Transações -->
      <div class="col-lg-6 mb-4 mb-lg-0">
          <div class="card h-100">
              <div class="card-body">
                  <h6 class="border-bottom pb-2 mb-3">
                      <i class="bi bi-clock-history me-2"></i>Recent Activity
                  </h6>
                  <ul class="list-group list-group-flush">
                      {% for tx in latest_transactions %}
                          <li class="list-group-item d-flex justify-content-between align-items-center">
                              <div>
                                  
                                  <strong class="d-block">
                                    <i class="{{ tx.category.icon|default:'bi-tag' }} fs-5" style="color: {{ tx.category.color|default:'#6c757d' }};"></i>
                                    {{ tx.description }} - {{ tx.type }}</strong>
                                  <!-- LÓGICA DE STATUS CORRIGIDA E ADICIONADA AQUI -->
                                  <small class="text-muted">
                                      {{ tx.date|date:"M. d, Y" }}
                                      
                                      <!-- Exibe o badge se não for 'Completed' -->
                                      {% if tx.status != 'COMPLETED' %}
                                      <span class="badge rounded-pill 
                                          {% if tx.status == 'OVERDUE' %}bg-danger-subtle text-danger-emphasis{% endif %}
                                      ">{{ tx.get_status_display }}</span>
                                      {% else %}
                                      <span class="badge rounded-pill 
                                          {% if tx.status == 'COMPLETED' %}bg-success-subtle text-success-emphasis{% endif %}
                                      ">{{ tx.get_status_display }}</span>
                                      {% endif %}
                                  </small>
                              </div>
                              <span class="fw-bold 
                                  {% if tx.type == 'EXPENSE' or tx.status == 'OVERDUE' %}text-danger{% elif tx.type == 'INCOME' %}text-success{% endif %}
                              ">
                                  {% if tx.type == 'EXPENSE' %}-{% else %}+{% endif %}
                                  {% if tx.origin_account %}
                                      {% money tx.value tx.origin_account.country %}
                                  {% elif tx.destination_account %}
                                      {% money tx.value tx.destination_account.country %}
                                  {% else %}
                                      {{ tx.value|stringformat:".2f" }}
                                  {% endif %}
                              </span>
                          </li>
                      {% empty %}
                          <li class="list-group-item text-muted small">No recent activity found.</li>
                      {% endfor %}
                  </ul>
              </div>
          </div>
      </div>
    </div>
    <!-- ############ FIM DO BLOCO CORRIGIDO ############ -->  
{% endblock %}




<!-- BLOCO CORRIGIDO ABAIXO -->
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById('accountBalanceChart');
    
    // Data passed from the Django view
    const chartLabels = JSON.parse('{{ chart_labels|escapejs }}');
    const chartData = JSON.parse('{{ chart_data|escapejs }}');

    if (ctx && chartLabels.length > 0) { // Check if there's data to show
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Account Balance',
            data: chartData,
            backgroundColor: [
              'rgba(0, 123, 255, 0.7)',
              'rgba(40, 167, 69, 0.7)',
              'rgba(255, 193, 7, 0.7)',
              'rgba(220, 53, 69, 0.7)',
              'rgba(23, 162, 184, 0.7)',
              'rgba(108, 117, 125, 0.7)',
              'rgba(111, 66, 193, 0.7)',
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed !== null) {
                            const value = parseFloat(context.parsed);
                            label += new Intl.NumberFormat('en-US', {
                                style: 'decimal',
                                minimumFractionDigits: 2
                            }).format(value);
                        }
                        return label;
                    }
                }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}