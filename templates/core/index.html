<!-- 
Arquivo: templates/core/index.html
(substitua o conteúdo inteiro)
-->
{% extends "base.html" %}
{% load money_extras %}

{% block title %}Dashboard{% endblock %}

{% block header %}
  {{ title }}
{% endblock %}

{% block content %}
  {% if not accounts %}
    <div class="text-center p-5 border rounded">
      <h3 class="h4">Welcome to your dashboard!</h3>
      <p class="text-muted">You don't have any active accounts yet.</p>
      <a href="{% url 'accounts:create' %}" class="btn btn-primary mt-2">
        <i class="bi bi-plus-circle"></i> Create your first account
      </a>
    </div>
  {% else %}
    <!-- Summary Cards -->
    <div class="row g-3">
      {% for item in currency_totals %}
        <div class="col-md-6 col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-muted">Total Balance ({{ item.country__currency_code }})</h5>
              <p class="card-text fs-2 fw-bold">
                {% money item.total symbol=item.country__currency_symbol %}
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Chart -->
    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Account Proportions</h5>
        <!-- Aumentamos um pouco a altura para o gráfico de pizza ficar melhor -->
        <div style="position: relative; height:300px">
            <canvas id="accountBalanceChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Accounts Table -->
    <div class="mt-4">
      <h3 class="h4 mb-3">Your Accounts</h3>
      {% include "accounts/_account_table.html" with accounts=accounts %}
    </div>
  {% endif %}
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const ctx = document.getElementById('accountBalanceChart');
    
    // Data passed from the Django view
    const chartLabels = JSON.parse('{{ chart_labels|escapejs }}');
    const chartData = JSON.parse('{{ chart_data|escapejs }}');

    if (ctx) {
      new Chart(ctx, {
        type: 'pie', // ALTERADO: de 'bar' para 'pie'
        data: {
          labels: chartLabels,
          datasets: [{
            label: 'Account Balance',
            data: chartData,
            // ALTERADO: Um array de cores para cada fatia da pizza
            backgroundColor: [
              'rgba(0, 123, 255, 0.7)',
              'rgba(40, 167, 69, 0.7)',
              'rgba(255, 193, 7, 0.7)',
              'rgba(220, 53, 69, 0.7)',
              'rgba(23, 162, 184, 0.7)',
              'rgba(108, 117, 125, 0.7)',
              'rgba(111, 66, 193, 0.7)',
            ],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // Permite que o gráfico preencha o container
          // REMOVIDO: Gráficos de pizza não têm eixos (scales)
          plugins: {
            legend: {
              display: true, // Habilitamos a legenda para identificar as contas
              position: 'top',
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.label || '';
                        if (label) {
                            label += ': ';
                        }
                        // ALTERADO: Usamos context.parsed em vez de context.parsed.y
                        if (context.parsed !== null) {
                            const value = parseFloat(context.parsed);
                            label += new Intl.NumberFormat('en-US', {
                                style: 'decimal',
                                minimumFractionDigits: 2
                            }).format(value);
                        }
                        return label;
                    }
                }
            }
          }
        }
      });
    }
  });
</script>
{% endblock %}